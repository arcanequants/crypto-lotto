# 🎯 FLUJO VISUAL COMPLETO - CryptoLotto

**Fecha**: 2025-10-23
**Blockchain**: BASE (Ethereum L2)
**Wallet**: Privy
**Swap**: Uniswap V3

---

## 🚀 FLUJO COMPLETO: DE INICIO A FIN

```
┌────────────────────────────────────────────────────────────────────────┐
│                    USUARIO ENTRA A LA PÁGINA                           │
│                    https://cryptolotto.com                             │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 1: ONBOARDING CON PRIVY                                         │
│                                                                        │
│  Usuario no está conectado:                                           │
│  → Click "CONNECT WALLET"                                             │
│  → Privy modal aparece                                                │
│                                                                        │
│  Opciones de login:                                                   │
│  ├─ Email                                                             │
│  ├─ Google                                                            │
│  ├─ Apple                                                             │
│  └─ Twitter                                                           │
│                                                                        │
│  Usuario elige "Google"                                               │
│  → Login con Google                                                   │
│  → Privy CREA wallet automáticamente en BASE                         │
│  → Usuario ahora tiene: embedded wallet en BASE                       │
│                                                                        │
│  Wallet address: 0xUser123ABC...                                      │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 2: USUARIO VE HOMEPAGE                                          │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    🎰 CryptoLotto                            │   │
│  │                                                              │   │
│  │  Choose Your Lottery:                                        │   │
│  │                                                              │   │
│  │  ┌─────────────────┐     ┌─────────────────┐              │   │
│  │  │  DAILY LOTTERY  │     │ WEEKLY LOTTERY  │              │   │
│  │  │                 │     │                 │              │   │
│  │  │  Draw: Daily    │     │  Draw: Sunday   │              │   │
│  │  │  @ 00:00 UTC    │     │  @ 20:00        │              │   │
│  │  │                 │     │                 │              │   │
│  │  │  Prize Pool:    │     │  Prize Pool:    │              │   │
│  │  │  $61,980        │     │  $1,239,600     │              │   │
│  │  │                 │     │                 │              │   │
│  │  │  [PLAY NOW]     │     │  [PLAY NOW]     │              │   │
│  │  └─────────────────┘     └─────────────────┘              │   │
│  └──────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 3: USUARIO ELIGE LOTERÍA                                        │
│                                                                        │
│  Usuario click "PLAY NOW" en → WEEKLY LOTTERY                        │
│                                                                        │
│  (El usuario DECIDE si juega DAILY o WEEKLY)                          │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 4: SELECCIONAR NÚMEROS                                          │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  Pick Your Numbers (WEEKLY LOTTERY)                          │   │
│  │                                                              │   │
│  │  Main Numbers (pick 5):                                      │   │
│  │  ┌───┬───┬───┬───┬───┬───┬───┬───┬───┐                    │   │
│  │  │ 1 │ 2 │ 3 │ 4 │[5]│ 6 │ 7 │ 8 │...│                    │   │
│  │  └───┴───┴───┴───┴───┴───┴───┴───┴───┘                    │   │
│  │  ┌───┬───┬───┬───┬───┬───┬───┬───┬───┐                    │   │
│  │  │ 10│ 11│[12]│ 13│ 14│ 15│ 16│ 17│...│                    │   │
│  │  └───┴───┴───┴───┴───┴───┴───┴───┴───┘                    │   │
│  │  ...hasta 69                                                 │   │
│  │                                                              │   │
│  │  PowerBall (pick 1):                                         │   │
│  │  ┌───┬───┬───┬───┬───┬───┬───┬───┐                        │   │
│  │  │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │[8]│...│                    │   │
│  │  └───┴───┴───┴───┴───┴───┴───┴───┘                        │   │
│  │  ...hasta 26                                                 │   │
│  │                                                              │   │
│  │  Selected: [5, 12, 23, 45, 67] Power: 8                    │   │
│  │  Price: $0.25 USDC                                           │   │
│  │                                                              │   │
│  │  [ADD TO CART]                                               │   │
│  └──────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 5: AGREGAR MÁS TICKETS (OPCIONAL)                              │
│                                                                        │
│  Usuario puede agregar más tickets:                                   │
│  - Ticket #1: [5, 12, 23, 45, 67] Power: 8 → WEEKLY → $0.25         │
│  - Ticket #2: [1, 2, 3, 4, 5] Power: 1 → WEEKLY → $0.25             │
│  - Ticket #3: [10, 20, 30, 40, 50] Power: 10 → DAILY → $0.25        │
│                                                                        │
│  CART:                                                                 │
│  ├─ 2 WEEKLY tickets = $0.50                                         │
│  ├─ 1 DAILY ticket = $0.25                                           │
│  └─ TOTAL: $0.75 USDC                                                │
│                                                                        │
│  [BUY ALL TICKETS]                                                     │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 6: PAGO CON PRIVY WALLET                                        │
│                                                                        │
│  Usuario click "BUY ALL TICKETS"                                      │
│  ↓                                                                     │
│  Privy modal aparece:                                                 │
│                                                                        │
│  ┌────────────────────────────────────────┐                          │
│  │  Approve Transaction                   │                          │
│  │                                         │                          │
│  │  You are about to spend:                │                          │
│  │  💵 $0.75 USDC                          │                          │
│  │                                         │                          │
│  │  To: CryptoLotto Contract               │                          │
│  │  0xContract123ABC...                    │                          │
│  │                                         │                          │
│  │  Gas fee: ~$0.008 ETH                   │                          │
│  │                                         │                          │
│  │  [APPROVE] [CANCEL]                     │                          │
│  └────────────────────────────────────────┘                          │
│                                                                        │
│  Usuario click "APPROVE"                                              │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 7: SMART CONTRACT RECIBE PAGO                                   │
│                                                                        │
│  BLOCKCHAIN TRANSACTION:                                               │
│                                                                        │
│  From: 0xUser123ABC... (Privy wallet del usuario)                    │
│  To: 0xContract... (CryptoLotto smart contract en BASE)               │
│  Value: 0.75 USDC                                                      │
│  Gas: 0.008 ETH (~$0.008 USD)                                         │
│                                                                        │
│  Smart Contract ejecuta:                                               │
│                                                                        │
│  function buyTicket() called 3 times:                                  │
│                                                                        │
│  1. buyTicket([5,12,23,45,67], 8, USDC, 0.25, WEEKLY)                │
│  2. buyTicket([1,2,3,4,5], 1, USDC, 0.25, WEEKLY)                    │
│  3. buyTicket([10,20,30,40,50], 10, USDC, 0.25, DAILY)               │
│                                                                        │
│  Transaction confirmed en ~2 segundos                                  │
│  ✅ Success                                                            │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 8: SMART CONTRACT SWAPPEA A CRYPTOS                             │
│                                                                        │
│  PARA CADA TICKET, el smart contract hace swaps via UNISWAP:          │
│                                                                        │
│  ═══════════════════════════════════════════════════════════════       │
│  TICKET #1 - WEEKLY ($0.25 USDC)                                      │
│  ═══════════════════════════════════════════════════════════════       │
│                                                                        │
│  $0.25 USDC → Split en 3 swaps:                                       │
│                                                                        │
│  Swap 1: 70% BTC                                                       │
│  ├─ Amount: $0.175 USDC                                               │
│  ├─ Route: USDC → cbBTC (Uniswap pool en BASE)                       │
│  ├─ Received: 0.0000016 cbBTC                                         │
│  └─ Destination: weeklyVault.cbBTC                                    │
│                                                                        │
│  Swap 2: 25% ETH                                                       │
│  ├─ Amount: $0.0625 USDC                                              │
│  ├─ Route: USDC → wETH (Uniswap pool en BASE)                        │
│  ├─ Received: 0.000015 wETH                                           │
│  └─ Destination: weeklyVault.wETH                                     │
│                                                                        │
│  Swap 3: 5% Token del Mes (MATIC - marzo 2025)                        │
│  ├─ Amount: $0.0125 USDC                                              │
│  ├─ Route: USDC → MATIC (Uniswap pool en BASE)                       │
│  ├─ Received: 0.0125 MATIC                                            │
│  └─ Destination: weeklyVault.tokenOfMonth["MATIC"]                   │
│                                                                        │
│  ═══════════════════════════════════════════════════════════════       │
│  TICKET #2 - WEEKLY ($0.25 USDC)                                      │
│  ═══════════════════════════════════════════════════════════════       │
│                                                                        │
│  Mismo proceso:                                                        │
│  ├─ Swap $0.175 → 0.0000016 cbBTC → weeklyVault.cbBTC               │
│  ├─ Swap $0.0625 → 0.000015 wETH → weeklyVault.wETH                 │
│  └─ Swap $0.0125 → 0.0125 MATIC → weeklyVault.tokenOfMonth          │
│                                                                        │
│  ═══════════════════════════════════════════════════════════════       │
│  TICKET #3 - DAILY ($0.25 USDC)                                       │
│  ═══════════════════════════════════════════════════════════════       │
│                                                                        │
│  ⚠️ IMPORTANTE: Este ticket va al DAILY vault (separado!)             │
│                                                                        │
│  ├─ Swap $0.175 → 0.0000016 cbBTC → dailyVault.cbBTC  ❗            │
│  ├─ Swap $0.0625 → 0.000015 wETH → dailyVault.wETH    ❗            │
│  └─ Swap $0.0125 → 0.0125 MATIC → dailyVault.tokenOfMonth ❗        │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 9: VAULTS ACTUALIZADOS                                          │
│                                                                        │
│  ESTADO ACTUAL DE LOS VAULTS EN EL SMART CONTRACT:                    │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  WEEKLY VAULT (2 tickets agregados)                          │   │
│  │                                                              │   │
│  │  cbBTC:  10.0 + (0.0000016 × 2) = 10.0000032 cbBTC          │   │
│  │  wETH:   40.0 + (0.000015 × 2) = 40.000030 wETH             │   │
│  │  MATIC:  2000 + (0.0125 × 2) = 2000.025 MATIC               │   │
│  │                                                              │   │
│  │  Total: $1,239,600 + $0.50 = $1,239,600.50                  │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  DAILY VAULT (1 ticket agregado)                             │   │
│  │                                                              │   │
│  │  cbBTC:  0.5 + 0.0000016 = 0.5000016 cbBTC                  │   │
│  │  wETH:   2.0 + 0.000015 = 2.000015 wETH                     │   │
│  │  MATIC:  100 + 0.0125 = 100.0125 MATIC                      │   │
│  │                                                              │   │
│  │  Total: $61,980 + $0.25 = $61,980.25                        │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                        │
│  🔑 KEY POINT: Los vaults son COMPLETAMENTE SEPARADOS                 │
│     - DAILY tiene su propio pool                                      │
│     - WEEKLY tiene su propio pool                                     │
│     - NO se mezclan NUNCA                                             │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 10: TICKETS REGISTRADOS                                         │
│                                                                        │
│  Smart Contract storage:                                               │
│                                                                        │
│  Ticket #12345:                                                        │
│  ├─ Owner: 0xUser123ABC...                                            │
│  ├─ Numbers: [5, 12, 23, 45, 67]                                      │
│  ├─ Power: 8                                                           │
│  ├─ DrawType: WEEKLY  ← ❗ IMPORTANTE                                 │
│  ├─ DrawId: 52 (Weekly draw #52)                                      │
│  ├─ MonthToken: "MATIC"                                               │
│  ├─ IsWinner: false (pending draw)                                    │
│  ├─ Tier: ""                                                           │
│  └─ Claimed: false                                                     │
│                                                                        │
│  Ticket #12346:                                                        │
│  ├─ Owner: 0xUser123ABC...                                            │
│  ├─ Numbers: [1, 2, 3, 4, 5]                                          │
│  ├─ Power: 1                                                           │
│  ├─ DrawType: WEEKLY  ← ❗                                            │
│  ├─ DrawId: 52 (mismo weekly draw)                                    │
│  ├─ MonthToken: "MATIC"                                               │
│  └─ ...                                                                │
│                                                                        │
│  Ticket #12347:                                                        │
│  ├─ Owner: 0xUser123ABC...                                            │
│  ├─ Numbers: [10, 20, 30, 40, 50]                                     │
│  ├─ Power: 10                                                          │
│  ├─ DrawType: DAILY  ← ❗ DIFERENTE!                                  │
│  ├─ DrawId: 365 (Daily draw #365)                                     │
│  ├─ MonthToken: "MATIC"                                               │
│  └─ ...                                                                │
│                                                                        │
│  Event emitted:                                                        │
│  ✅ TicketPurchased(0xUser123ABC, 12345, WEEKLY, 52)                 │
│  ✅ TicketPurchased(0xUser123ABC, 12346, WEEKLY, 52)                 │
│  ✅ TicketPurchased(0xUser123ABC, 12347, DAILY, 365)                 │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 11: USUARIO VE CONFIRMACIÓN                                     │
│                                                                        │
│  Frontend detecta eventos y actualiza UI:                              │
│                                                                        │
│  ┌────────────────────────────────────────┐                          │
│  │  ✅ Tickets Purchased!                 │                          │
│  │                                         │                          │
│  │  Weekly Lottery:                        │                          │
│  │  ├─ Ticket #12345                       │                          │
│  │  │  Numbers: [5,12,23,45,67] Power: 8  │                          │
│  │  │  Draw: Sunday @ 20:00                │                          │
│  │  │                                       │                          │
│  │  └─ Ticket #12346                       │                          │
│  │     Numbers: [1,2,3,4,5] Power: 1      │                          │
│  │     Draw: Sunday @ 20:00                │                          │
│  │                                         │                          │
│  │  Daily Lottery:                         │                          │
│  │  └─ Ticket #12347                       │                          │
│  │     Numbers: [10,20,30,40,50] Power: 10│                          │
│  │     Draw: Tomorrow @ 00:00 UTC          │                          │
│  │                                         │                          │
│  │  Total Spent: $0.75 USDC                │                          │
│  │  Gas Fee: $0.008 ETH                    │                          │
│  │                                         │                          │
│  │  [VIEW MY TICKETS]                      │                          │
│  └────────────────────────────────────────┘                          │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
                          ⏰ ESPERAR AL SORTEO ⏰
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 12: SORTEO DAILY (cada día @ 00:00 UTC)                        │
│                                                                        │
│  CRON JOB (Vercel):                                                    │
│  → Trigger @ 00:00 UTC diario                                         │
│  → POST /api/cron/trigger-draw?type=daily                             │
│                                                                        │
│  BACKEND API:                                                          │
│  → Call smart contract:                                                │
│     contract.requestRandomNumbers(365, DrawType.DAILY)                │
│                                                                        │
│  SMART CONTRACT:                                                       │
│  → Request a Chainlink VRF:                                            │
│     requestRandomWords(subId, 6 numbers)                               │
│                                                                        │
│  CHAINLINK VRF:                                                        │
│  → Genera 6 números random                                             │
│  → Callback al smart contract                                          │
│  → Cobra $1.00 LINK de nuestra subscription                           │
│                                                                        │
│  SMART CONTRACT (callback):                                            │
│  → Recibe números: [12, 23, 34, 45, 56] Power: 9                     │
│  → Actualiza Draw #365:                                                │
│    draws[365].winningNumbers = [12, 23, 34, 45, 56]                  │
│    draws[365].powerNumber = 9                                          │
│    draws[365].status = "completed"                                     │
│                                                                        │
│  → Determina ganadores:                                                │
│    Loop por TODOS los tickets de DAILY draw #365:                     │
│                                                                        │
│    Ticket #12347: [10,20,30,40,50] Power: 10                         │
│    ├─ Matches: 0                                                       │
│    ├─ Power match: false                                               │
│    └─ Result: NOT a winner ❌                                          │
│                                                                        │
│    ... (otros tickets DAILY)                                           │
│                                                                        │
│  Event emitted:                                                        │
│  ✅ DrawCompleted(365, DAILY, [12,23,34,45,56], 9)                   │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 13: SORTEO WEEKLY (cada domingo @ 20:00)                       │
│                                                                        │
│  CRON JOB (Vercel):                                                    │
│  → Trigger @ domingo 20:00                                             │
│  → POST /api/cron/trigger-draw?type=weekly                            │
│                                                                        │
│  SMART CONTRACT:                                                       │
│  → Request a Chainlink VRF                                             │
│  → Recibe números: [5, 12, 23, 45, 67] Power: 8  ← ¡JACKPOT!        │
│                                                                        │
│  → Determina ganadores:                                                │
│    Loop por TODOS los tickets de WEEKLY draw #52:                     │
│                                                                        │
│    Ticket #12345: [5,12,23,45,67] Power: 8                           │
│    ├─ Matches: 5 ✅                                                    │
│    ├─ Power match: true ✅                                             │
│    └─ Result: WINNER! Tier 5+1 (JACKPOT) 🎉                          │
│        ticket.isWinner = true                                          │
│        ticket.tier = "5+1"                                             │
│                                                                        │
│    Ticket #12346: [1,2,3,4,5] Power: 1                               │
│    ├─ Matches: 1 (solo el 5)                                          │
│    └─ Result: NOT a winner ❌                                          │
│                                                                        │
│  Event emitted:                                                        │
│  ✅ DrawCompleted(52, WEEKLY, [5,12,23,45,67], 8)                    │
│  ✅ WinnerDetermined(12345, "5+1", 0xUser123ABC)                     │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 14: USUARIO VE NOTIFICACIÓN                                     │
│                                                                        │
│  Frontend escucha eventos:                                             │
│                                                                        │
│  ┌────────────────────────────────────────┐                          │
│  │  🎉🎉🎉 YOU WON THE JACKPOT! 🎉🎉🎉    │                          │
│  │                                         │                          │
│  │  Weekly Draw #52 Results:               │                          │
│  │  Winning Numbers: [5,12,23,45,67]      │                          │
│  │  PowerBall: 8                           │                          │
│  │                                         │                          │
│  │  Your Ticket #12345:                    │                          │
│  │  [5,12,23,45,67] Power: 8              │                          │
│  │  ✅ 5 MATCHES + POWERBALL               │                          │
│  │  🏆 TIER 5+1 - JACKPOT!                 │                          │
│  │                                         │                          │
│  │  Your Prize:                            │                          │
│  │  💰 2.5 cbBTC ($270,000)                │                          │
│  │  💎 10.0 wETH ($39,400)                 │                          │
│  │  🟣 500 MATIC ($500)                    │                          │
│  │                                         │                          │
│  │  Total Value: $309,900                  │                          │
│  │                                         │                          │
│  │  [CLAIM PRIZE]                          │                          │
│  └────────────────────────────────────────┘                          │
│                                                                        │
│  (Email enviado también)                                               │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 15: USUARIO HACE CLAIM                                          │
│                                                                        │
│  Usuario click "CLAIM PRIZE"                                           │
│  ↓                                                                     │
│  Frontend call:                                                        │
│  contract.claimPrize(12345)                                            │
│                                                                        │
│  SMART CONTRACT ejecuta:                                               │
│                                                                        │
│  function claimPrize(12345) {                                          │
│    // 1. Verificaciones                                                │
│    ✅ require(ticket.isWinner)                                         │
│    ✅ require(!ticket.claimed)                                         │
│    ✅ require(ticket.owner == msg.sender)                              │
│                                                                        │
│    // 2. Determinar vault correcto                                     │
│    Vault = weeklyVault  (porque ticket.drawType == WEEKLY)            │
│                                                                        │
│    // 3. Calcular premio                                               │
│    tier = "5+1" → tierPercentage = 50%                                │
│    winnersCount = _countWinners(WEEKLY, "5+1") → 2 ganadores         │
│                                                                        │
│    cbbtcPrize = (weeklyVault.cbBTC × 50) / (100 × 2)                  │
│               = (10.0 × 50) / 200                                      │
│               = 2.5 cbBTC                                              │
│                                                                        │
│    wethPrize = (weeklyVault.wETH × 50) / (100 × 2)                    │
│              = (40.0 × 50) / 200                                       │
│              = 10.0 wETH                                               │
│                                                                        │
│    tokenPrize = (weeklyVault.tokenOfMonth["MATIC"] × 50) / (100 × 2)  │
│               = (2000 × 50) / 200                                      │
│               = 500 MATIC                                              │
│                                                                        │
│    // 4. TRANSFERIR tokens del vault al usuario                       │
│    IERC20(CBBTC).transfer(0xUser123ABC, 2.5 cbBTC)                    │
│    IERC20(WETH).transfer(0xUser123ABC, 10.0 wETH)                     │
│    IERC20(MATIC).transfer(0xUser123ABC, 500 MATIC)                    │
│                                                                        │
│    // 5. Actualizar vaults                                             │
│    weeklyVault.cbBTC -= 2.5  → Quedó: 7.5 cbBTC                       │
│    weeklyVault.wETH -= 10.0  → Quedó: 30.0 wETH                       │
│    weeklyVault.tokenOfMonth["MATIC"] -= 500  → Quedó: 1500 MATIC     │
│                                                                        │
│    // 6. Marcar ticket como claimed                                    │
│    ticket.claimed = true                                               │
│    ticket.claimedAt = block.timestamp                                  │
│                                                                        │
│    // 7. Emit event                                                    │
│    emit PrizeClaimed(12345, 0xUser123ABC, 2.5, 10.0, 500)            │
│  }                                                                     │
│                                                                        │
│  Gas cost: ~$0.015 USD                                                 │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 16: USUARIO RECIBE PREMIOS EN PRIVY WALLET                      │
│                                                                        │
│  Privy wallet del usuario actualizada:                                 │
│                                                                        │
│  ┌────────────────────────────────────────┐                          │
│  │  Your Wallet (BASE Network)             │                          │
│  │                                         │                          │
│  │  💰 2.5 cbBTC ($270,000)                │                          │
│  │  💎 10.0 wETH ($39,400)                 │                          │
│  │  🟣 500 MATIC ($500)                    │                          │
│  │                                         │                          │
│  │  Total Balance: $309,900                │                          │
│  │                                         │                          │
│  │  [SEND] [RECEIVE] [CONVERT TO USDC]     │                          │
│  └────────────────────────────────────────┘                          │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 17: USUARIO CONVIERTE A USDC (UNISWAP WIDGET)                   │
│                                                                        │
│  Usuario click "CONVERT TO USDC"                                       │
│  ↓                                                                     │
│  Modal con Uniswap widget aparece:                                     │
│                                                                        │
│  ┌─────────────────────────────────────────────────────────────┐     │
│  │  Swap Your Prizes to USDC                                   │     │
│  │                                                             │     │
│  │  You have:                                                  │     │
│  │  ○ 2.5 cbBTC ($270,000)                                     │     │
│  │  ○ 10.0 wETH ($39,400)                                      │     │
│  │  ○ 500 MATIC ($500)                                         │     │
│  │                                                             │     │
│  │  ═══════════════════════════════════════                   │     │
│  │                                                             │     │
│  │  Swap #1: cbBTC → USDC                                      │     │
│  │  ┌───────────────────────────────┐                         │     │
│  │  │ FROM: 2.5 cbBTC               │                         │     │
│  │  │ TO: ~$269,900 USDC            │                         │     │
│  │  │ Fee: $100 (0.03%)             │                         │     │
│  │  │                               │                         │     │
│  │  │ [SWAP]                        │                         │     │
│  │  └───────────────────────────────┘                         │     │
│  │                                                             │     │
│  │  Swap #2: wETH → USDC                                       │     │
│  │  ┌───────────────────────────────┐                         │     │
│  │  │ FROM: 10.0 wETH               │                         │     │
│  │  │ TO: ~$39,388 USDC             │                         │     │
│  │  │ Fee: $12 (0.03%)              │                         │     │
│  │  │                               │                         │     │
│  │  │ [SWAP]                        │                         │     │
│  │  └───────────────────────────────┘                         │     │
│  │                                                             │     │
│  │  Swap #3: MATIC → USDC                                      │     │
│  │  ┌───────────────────────────────┐                         │     │
│  │  │ FROM: 500 MATIC               │                         │     │
│  │  │ TO: ~$499 USDC                │                         │     │
│  │  │ Fee: $1 (0.2%)                │                         │     │
│  │  │                               │                         │     │
│  │  │ [SWAP]                        │                         │     │
│  │  └───────────────────────────────┘                         │     │
│  │                                                             │     │
│  │  Or swap all at once:                                       │     │
│  │  [SWAP ALL TO USDC]                                         │     │
│  └─────────────────────────────────────────────────────────────┘     │
│                                                                        │
│  Usuario click "SWAP ALL TO USDC"                                     │
│  ↓                                                                     │
│  Uniswap ejecuta 3 swaps en BASE:                                     │
│  ├─ 2.5 cbBTC → $269,900 USDC                                         │
│  ├─ 10.0 wETH → $39,388 USDC                                          │
│  └─ 500 MATIC → $499 USDC                                             │
│                                                                        │
│  Total fees: ~$113 USD (0.03% promedio)                               │
│  Gas fees: ~$0.15 USD (3 transactions)                                │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 18: USUARIO TIENE USDC LÍQUIDO                                  │
│                                                                        │
│  Privy wallet final:                                                   │
│                                                                        │
│  ┌────────────────────────────────────────┐                          │
│  │  Your Wallet (BASE Network)             │                          │
│  │                                         │                          │
│  │  💵 $309,787 USDC                       │                          │
│  │                                         │                          │
│  │  Available Actions:                     │                          │
│  │  ├─ Send to Coinbase                    │                          │
│  │  ├─ Send to Binance                     │                          │
│  │  ├─ Send to any wallet                  │                          │
│  │  └─ Keep in Privy wallet                │                          │
│  │                                         │                          │
│  │  [SEND] [RECEIVE]                       │                          │
│  └────────────────────────────────────────┘                          │
└────────────────────────────────────────────────────────────────────────┘
                                   ↓
┌────────────────────────────────────────────────────────────────────────┐
│  PASO 19 (OPCIONAL): ENVIAR A EXCHANGE                                │
│                                                                        │
│  Usuario quiere convertir a USD fiat:                                  │
│                                                                        │
│  1. Click "SEND"                                                       │
│  2. Copiar address de Coinbase (BASE network)                         │
│  3. Paste en Privy wallet                                              │
│  4. Amount: $309,787 USDC                                              │
│  5. Confirm transaction                                                │
│                                                                        │
│  ↓                                                                     │
│  USDC enviado a Coinbase en ~5 segundos                               │
│  Gas fee: ~$0.001 USD                                                  │
│                                                                        │
│  ↓                                                                     │
│  En Coinbase:                                                          │
│  - USDC recibido: $309,787                                             │
│  - Click "SELL USDC"                                                   │
│  - Receive: $309,787 USD                                               │
│  - Transfer to bank account                                            │
│                                                                        │
│  ✅ CASH IN BANK: $309,787 USD                                        │
└────────────────────────────────────────────────────────────────────────┘

---

## 🔑 PUNTOS CLAVE DEL FLUJO

### 1. Usuario ELIGE Daily o Weekly
```
Al comprar ticket, usuario selecciona:
├─ DAILY → Sorteo diario @ 00:00 UTC
└─ WEEKLY → Sorteo semanal @ domingo 20:00

El ticket se guarda con: ticket.drawType = DAILY o WEEKLY
```

### 2. Fondos van a VAULTS SEPARADOS
```
Ticket DAILY:
├─ USDC → Swap → cbBTC + wETH + token
└─ Guardado en: dailyVault

Ticket WEEKLY:
├─ USDC → Swap → cbBTC + wETH + token
└─ Guardado en: weeklyVault

⚠️ NUNCA se mezclan
```

### 3. Sorteos son INDEPENDIENTES
```
DAILY Draw:
├─ Trigger: Cada día @ 00:00 UTC
├─ Chainlink VRF genera números
├─ Solo tickets DAILY participan
└─ Premios salen de dailyVault

WEEKLY Draw:
├─ Trigger: Cada domingo @ 20:00
├─ Chainlink VRF genera números
├─ Solo tickets WEEKLY participan
└─ Premios salen de weeklyVault
```

### 4. Claim usa vault correcto
```solidity
function claimPrize(ticketId) {
  // Determinar vault según tipo de ticket
  if (ticket.drawType == DAILY) {
    vault = dailyVault
  } else {
    vault = weeklyVault
  }

  // Premio sale de ese vault específico
  prize = (vault × tier%) / winnersCount

  // Transferir al usuario
  transfer(prize)
}
```

### 5. Token del mes acumula en AMBOS vaults
```
Marzo 2025 - Token: MATIC

dailyVault.tokenOfMonth["MATIC"]:
├─ Día 1: +15 MATIC
├─ Día 2: +18 MATIC
├─ ...
└─ Día 30: Total = 450 MATIC

weeklyVault.tokenOfMonth["MATIC"]:
├─ Semana 1: +120 MATIC
├─ Semana 2: +135 MATIC
├─ ...
└─ Semana 4: Total = 2000 MATIC

Ambos acumulan el mismo token (MATIC)
Pero en vaults separados
```

---

## 📊 VISUALIZACIÓN DE LA ARQUITECTURA

```
┌─────────────────────────────────────────────────────────────────────┐
│                    SMART CONTRACT (BASE)                            │
│                                                                     │
│  ┌────────────────────────────────┐  ┌────────────────────────────┐│
│  │  DAILY LOTTERY SYSTEM          │  │  WEEKLY LOTTERY SYSTEM     ││
│  │                                │  │                            ││
│  │  ┌──────────────────────────┐ │  │  ┌──────────────────────┐ ││
│  │  │  Daily Vault             │ │  │  │  Weekly Vault        │ ││
│  │  │  ├─ cbBTC: 0.5           │ │  │  │  ├─ cbBTC: 10.0      │ ││
│  │  │  ├─ wETH: 2.0            │ │  │  │  ├─ wETH: 40.0       │ ││
│  │  │  └─ MATIC: 100           │ │  │  │  └─ MATIC: 2000      │ ││
│  │  │  Total: $61,980          │ │  │  │  Total: $1,239,600   │ ││
│  │  └──────────────────────────┘ │  │  └──────────────────────┘ ││
│  │                                │  │                            ││
│  │  ┌──────────────────────────┐ │  │  ┌──────────────────────┐ ││
│  │  │  Daily Tickets           │ │  │  │  Weekly Tickets      │ ││
│  │  │  ├─ Ticket #1            │ │  │  │  ├─ Ticket #100      │ ││
│  │  │  ├─ Ticket #2            │ │  │  │  ├─ Ticket #101      │ ││
│  │  │  └─ ...                  │ │  │  │  └─ ...              │ ││
│  │  └──────────────────────────┘ │  │  └──────────────────────┘ ││
│  │                                │  │                            ││
│  │  ┌──────────────────────────┐ │  │  ┌──────────────────────┐ ││
│  │  │  Daily Draws             │ │  │  │  Weekly Draws        │ ││
│  │  │  ├─ Draw #365            │ │  │  │  ├─ Draw #52         │ ││
│  │  │  │  @ 00:00 UTC          │ │  │  │  │  @ Sunday 20:00   │ ││
│  │  │  │  [12,23,34,45,56] 9  │ │  │  │  │  [5,12,23,45,67] 8│ ││
│  │  │  └─ ...                  │ │  │  │  └─ ...              │ ││
│  │  └──────────────────────────┘ │  │  └──────────────────────┘ ││
│  │                                │  │                            ││
│  └────────────────────────────────┘  └────────────────────────────┘│
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │  SHARED COMPONENTS                                           │  │
│  │  ├─ Chainlink VRF (genera números para ambos)               │  │
│  │  ├─ Uniswap Router (swaps USDC → crypto para ambos)         │  │
│  │  └─ Token del mes (ambos vaults usan el mismo token)        │  │
│  └─────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 💰 EJEMPLO COMPLETO CON NÚMEROS REALES

### Usuario compra 3 tickets:

```
Ticket A: [5,12,23,45,67] Power: 8 → WEEKLY → $0.25 USDC
Ticket B: [1,2,3,4,5] Power: 1 → WEEKLY → $0.25 USDC
Ticket C: [10,20,30,40,50] Power: 10 → DAILY → $0.25 USDC

Total pagado: $0.75 USDC
```

### Smart contract swappea:

```
TICKET A (WEEKLY):
$0.25 USDC →
├─ $0.175 (70%) → 0.0000016 cbBTC → weeklyVault.cbBTC ✅
├─ $0.0625 (25%) → 0.000015 wETH → weeklyVault.wETH ✅
└─ $0.0125 (5%) → 0.0125 MATIC → weeklyVault.tokenOfMonth["MATIC"] ✅

TICKET B (WEEKLY):
$0.25 USDC →
├─ $0.175 (70%) → 0.0000016 cbBTC → weeklyVault.cbBTC ✅
├─ $0.0625 (25%) → 0.000015 wETH → weeklyVault.wETH ✅
└─ $0.0125 (5%) → 0.0125 MATIC → weeklyVault.tokenOfMonth["MATIC"] ✅

TICKET C (DAILY):
$0.25 USDC →
├─ $0.175 (70%) → 0.0000016 cbBTC → dailyVault.cbBTC ❗
├─ $0.0625 (25%) → 0.000015 wETH → dailyVault.wETH ❗
└─ $0.0125 (5%) → 0.0125 MATIC → dailyVault.tokenOfMonth["MATIC"] ❗
```

### Sorteos separados:

```
DAILY DRAW #365 (mañana @ 00:00 UTC):
├─ Winning numbers: [12,23,34,45,56] Power: 9
├─ Ticket C: [10,20,30,40,50] Power: 10
├─ Matches: 0
└─ Result: NOT a winner ❌

WEEKLY DRAW #52 (domingo @ 20:00):
├─ Winning numbers: [5,12,23,45,67] Power: 8
├─ Ticket A: [5,12,23,45,67] Power: 8
│   ├─ Matches: 5 ✅
│   ├─ Power match: true ✅
│   └─ Result: JACKPOT! (Tier 5+1) 🎉
└─ Ticket B: [1,2,3,4,5] Power: 1
    ├─ Matches: 1 (solo el 5)
    └─ Result: NOT a winner ❌
```

### Usuario gana y hace claim:

```
Ticket A ganó WEEKLY Jackpot (Tier 5+1)

weeklyVault state:
├─ cbBTC: 10.0
├─ wETH: 40.0
└─ MATIC: 2000

Winners en Tier 5+1: 2 personas (Usuario A y otra persona)

Premio Usuario A:
├─ cbBTC: (10.0 × 50%) / 2 = 2.5 cbBTC ($270,000)
├─ wETH: (40.0 × 50%) / 2 = 10.0 wETH ($39,400)
└─ MATIC: (2000 × 50%) / 2 = 500 MATIC ($500)

Total: $309,900

Usuario A recibe en Privy wallet:
✅ 2.5 cbBTC
✅ 10.0 wETH
✅ 500 MATIC
```

### Usuario convierte a USDC:

```
Uniswap widget:
├─ 2.5 cbBTC → $269,900 USDC
├─ 10.0 wETH → $39,388 USDC
└─ 500 MATIC → $499 USDC

Total: $309,787 USDC (con fees y slippage)

Privy wallet final:
💵 $309,787 USDC
```

---

## ✅ FLUJO FINAL RESUMIDO

```
1. Usuario entra → Login con Privy
2. Usuario elige DAILY o WEEKLY
3. Usuario selecciona números
4. Usuario paga con USDC
5. Smart contract recibe USDC
6. Smart contract swappea USDC → cbBTC + wETH + token (Uniswap)
7. Smart contract guarda en vault correcto (daily o weekly)
8. Smart contract registra ticket con drawType
9. CRON trigger sorteo (Chainlink VRF)
10. Smart contract determina ganadores
11. Usuario hace claim
12. Smart contract transfiere del vault correcto
13. Usuario recibe en Privy wallet
14. Usuario swappea a USDC (Uniswap widget)
15. Usuario envía a exchange
16. Usuario vende por USD fiat
```

---

**FLUJO COMPLETO Y VISUAL** ✅

**¿Está claro cómo se separan DAILY y WEEKLY, socio?** 🚀
